$OpenBSD: patch-_oasis,v 1.1 2013/01/10 18:55:30 chrisz Exp $

Link to libcharset

--- _oasis.orig	Mon Oct  8 11:21:18 2012
+++ _oasis	Fri Jan  4 00:00:04 2013
@@ -62,6 +62,11 @@ Library "lambda-term"
     lTerm_term_stubs.c,
     lTerm_unix_stubs.c,
     lTerm_windows_stubs.c
+  CCOpt:
+    -I/usr/local/include
+  CCLib:
+    -L/usr/local/lib
+    -lcharset
 
 # +-------------------------------------------------------------------+
 # | Examples                                                          |
$OpenBSD: patch-_tags,v 1.1 2013/01/10 18:55:30 chrisz Exp $

autogenerated by oasis

--- _tags.orig	Mon Oct  8 11:21:18 2012
+++ _tags	Fri Jan  4 00:00:12 2013
@@ -19,6 +19,15 @@
 "_darcs": not_hygienic
 # Library lambda-term
 "src/lambda-term.cmxs": use_lambda-term
+<src/*.ml{,i}>: oasis_library_lambda_term_ccopt
+"src/lTerm_term_stubs.c": oasis_library_lambda_term_ccopt
+"src/lTerm_unix_stubs.c": oasis_library_lambda_term_ccopt
+"src/lTerm_windows_stubs.c": oasis_library_lambda_term_ccopt
+<src/lambda-term.{cma,cmxa}>: oasis_library_lambda_term_cclib
+"src/liblambda-term_stubs.lib": oasis_library_lambda_term_cclib
+"src/dlllambda-term_stubs.dll": oasis_library_lambda_term_cclib
+"src/liblambda-term_stubs.a": oasis_library_lambda_term_cclib
+"src/dlllambda-term_stubs.so": oasis_library_lambda_term_cclib
 <src/lambda-term.{cma,cmxa}>: use_liblambda-term_stubs
 <src/*.ml{,i}>: pkg_lwt
 <src/*.ml{,i}>: pkg_lwt.unix
$OpenBSD: patch-myocamlbuild_ml,v 1.1 2013/01/10 18:55:30 chrisz Exp $

autogenerated by oasis

--- myocamlbuild.ml.orig	Mon Oct  8 11:21:18 2012
+++ myocamlbuild.ml	Fri Jan  4 00:00:12 2013
@@ -488,7 +488,25 @@ let package_default =
   {
      MyOCamlbuildBase.lib_ocaml = [("lambda-term", ["src"])];
      lib_c = [("lambda-term", "src", [])];
-     flags = [];
+     flags =
+       [
+          (["oasis_library_lambda_term_ccopt"; "compile"],
+            [(OASISExpr.EBool true, S [A "-ccopt"; A "-I/usr/local/include"])
+            ]);
+          (["oasis_library_lambda_term_cclib"; "link"],
+            [
+               (OASISExpr.EBool true,
+                 S
+                   [
+                      A "-cclib";
+                      A "-L/usr/local/lib";
+                      A "-cclib";
+                      A "-lcharset"
+                   ])
+            ]);
+          (["oasis_library_lambda_term_cclib"; "ocamlmklib"; "c"],
+            [(OASISExpr.EBool true, S [A "-L/usr/local/lib"; A "-lcharset"])])
+       ];
      includes =
        [("tools", ["src"]); ("tests", ["src"]); ("examples", ["src"])];
      }
$OpenBSD: patch-setup_ml,v 1.1 2013/01/10 18:55:30 chrisz Exp $

autogenerated by oasis

--- setup.ml.orig	Mon Oct  8 11:21:18 2012
+++ setup.ml	Fri Jan  4 00:00:12 2013
@@ -5964,8 +5964,13 @@ let setup_t =
                            "lTerm_windows_stubs.c"
                         ];
                       bs_data_files = [];
-                      bs_ccopt = [(OASISExpr.EBool true, [])];
-                      bs_cclib = [(OASISExpr.EBool true, [])];
+                      bs_ccopt =
+                        [(OASISExpr.EBool true, ["-I/usr/local/include"])];
+                      bs_cclib =
+                        [
+                           (OASISExpr.EBool true,
+                             ["-L/usr/local/lib"; "-lcharset"])
+                        ];
                       bs_dlllib = [(OASISExpr.EBool true, [])];
                       bs_dllpath = [(OASISExpr.EBool true, [])];
                       bs_byteopt = [(OASISExpr.EBool true, [])];
$OpenBSD: patch-src_lTerm_unix_stubs_c,v 1.1 2013/01/10 18:55:30 chrisz Exp $

work around nl_langinfo(CODESET) bug for LC_CTYPE=C
see
http://hackage.haskell.org/trac/ghc/ticket/4080
http://www.haible.de/bruno/packages-libcharset.html

--- src/lTerm_unix_stubs.c.orig	Thu Dec 13 13:06:26 2012
+++ src/lTerm_unix_stubs.c	Thu Dec 13 13:23:28 2012
@@ -29,7 +29,7 @@ CAMLprim value lt_unix_get_system_encoding()
 
 #include <signal.h>
 #include <locale.h>
-#include <langinfo.h>
+#include <localcharset.h>
 
 CAMLprim value lt_unix_get_sigwinch()
 {
@@ -45,9 +45,9 @@ CAMLprim value lt_unix_get_sigwinch()
 CAMLprim value lt_unix_get_system_encoding()
 {
   /* Set the locale according to environment variables: */
-  char *locale = setlocale(LC_CTYPE, "");
+  const char *locale = setlocale(LC_CTYPE, "");
   /* Get the codeset used by current locale: */
-  char *codeset = nl_langinfo(CODESET);
+  const char *codeset = locale_charset();
   /* Reset the locale: */
   setlocale(LC_CTYPE, locale);
   /* If the encoding cannot be determined, just use ascii: */
